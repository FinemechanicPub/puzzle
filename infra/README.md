# Подготовка сервера к развертыванию приложения
## Предварительные требования
- у вас должен быть терминальный доступ к серверу;
- на сервере должен быть установлен `Docker` ([инструкции](https://docs.docker.com/engine/install/)).

## Копирование файлов
Скопируйте содержимое папки [infra](../infra/) на сервер. Пример использования команды `scp` для копирования файлов по протоколу `ssh` в папку пользователя `username` на сервере `example.com` (предварительно нужно перейти в корневую папку этого репозитория):
```bash
scp -r infra username@example.com:~
```

## Замечания по архитектуре

Для обеспечения возможности запуска нескольких версий приложения (например, основной и отладочной) на сервере запускается основной прокси-сервер на основе образа [Swag](https://github.com/linuxserver/docker-swag). Он предназначен для приёма зашифрованных соединений `SSL` и распределения запросов на сервера приложений. Для его настройки предназначена папка [proxy](./proxy/).

Для настройки сервера приложения предназначена папка [puzzle](./puzzle/).


## Настройка основного прокси-сервера

Конфигурационные файлы находятся в папке [proxy](./proxy/).
Если планируется использовать для приложения поддомен, отличный от "puzzle", нужно внести соответствующие изменения в строке `server_name` в файле конфигурации [puzzle.subdomain.conf](proxy/proxy-confs/puzzle.subdomain.conf). При желании, файл конфигурации также можно переименовать[^1].

[^1]: имя файла должно оканчиваться на ".subdomain.conf".

### Настройка получения SSL сертификатов
Скопируйте содержимое файла [.env.sample](proxy/.env.sample) в файл .env в той же папке. Замените значения переменных на соответствующие вашему серверу:
- TZ - часовой пояс;
- URL - основной домен приложения;
- EXTRA_DOMAINS - дополнительные домены, например, для отладочной версии приложения;
- EMAIL - адрес электронной почты, который будет использовать [Let's Encrypt](https://letsencrypt.org/) при необходимости связаться с владельцем домена.

Можно использовать и другие настройки Swag ([инструкции](https://github.com/linuxserver/docker-swag?tab=readme-ov-file#parameters)).

### Запуск прокси-сервера
Находясь в папке [proxy](./proxy/), выполните команду 
```bash
docker compose up -d
```
При первом запуске `Swag` попробует получить сертификаты SSL. Следить за этим процессом можно по выводу контейнера:
```bash
docker logs -f swag
```
После успешного запуска можно поверить работу прокси-сервера, обратившись по адресу приложения в браузере. Должна отобразиться страница ошибки "502 - Bad Gateway", шаблон которой находится в файле [502.html](proxy/static/502.html).

## Настройка сервера приложения

Конфигурационные файлы находятся в папке [puzzle](./puzzle/).

### Переменные
Скопируйте содержимое файла [.env.sample](puzzle/.env.sample) в файл .env в той же папке.

Отредактируйте значения переменных в файле .env. Обязательно нужно изменить значения следующих переменных: `POSTGRES_PASSWORD`, `CONNECTION_STRING`, `SECRET`.

- POSTGRES_DB - имя базы данных приложения
- POSTGRES_USER - имя пользователя баы данных
- POSTGRES_PASSWORD - пароль пользователя базы данных
- POSTGRES_HOST - сервер базы данных
- POSTGRES_PORT - порт сервера базы данных
- CONNECTION_STRING - строка подключения к базе данных
- FIRST_SUPERUSER_EMAIL - адрес электронной почты администратора приложения
- FIRST_SUPERUSER_PASSWORD - пароль администратора приложения
- SECRET - случайный набор символов для шифрования данных
- BACKEND_IMAGE - образ серверной части приложения
- FRONTEND_IMAGE - образ `Nginx` с клиентской частью приложения

Строка подключения `CONNECTION_STRING` должна использовать те же реквизиты, что заданы в переменных `POSTGRES_`.

Переменная `POSTGRES_HOST` должна указывать на сервис базы данных как он задан в файле конфигурации [docker-compose.yaml](puzzle/docker-compose.yaml).

Переменные `BACKEND_IMAGE` и `BACKEND_IMAGE` по умолчанию указывают на хранилище образов этого репозитория. Измените их, если вы собрали свои образы для приложения.

### Запуск сервера приложения
Находясь в папке [puzzle](./puzzle/), выполните команду 
```bash
docker compose up -d
```

Конфигурация полагается на наличие Docker-сети "puzzle", которая создается при запуске [прокси-севрера](#настройка-сервера-приложения).
